<?xml version="1.0" encoding="UTF-8" ?>

<project name="My subsite" default="help">

    <!-- Import production database. -->
    <target name="import-prod-db" description="Import production database." depends="download-prod-db">
        <echo msg="Import production database." />
        <!-- Drop database, create if necessary and import the dump. -->
        <phingcall target="drush-sql-drop" />
        <phingcall target="drush-sql-create" />
        <phingcall target="drush-sql-import">
            <property name="database-file" value="tmp/${gunzipped.filename}" />
        </phingcall>
    </target>

    <!-- Download the production database. -->
    <target name="download-prod-db" description="Download the production database." >
        <echo msg="Download the production database." />
        <!--Strips gz suffix. -->
        <php expression="substr('${project.database.filename}', 0, -3)" returnProperty="gunzipped.filename" level="debug"/>
        <if>
            <not>
                <!-- Check if we have a previously downloaded dump available. -->
                <available file="tmp/${gunzipped.filename}" type="file" property="gunzipped.project.db" />
            </not>
            <then>
                <!-- If not available, download and unzip the file. -->
                <phingcall target="wget-prod-db" />
                <exec command="gunzip tmp/${project.database.filename}" checkreturn="true" passthru="false" logoutput="true" />
            </then>
            <else>
                <!-- Inform user if file was already downloaded. -->
                <echo msg="File ${gunzipped.filename} already downloaded." />
                <echo msg="Proceeding to import." />
            </else>
        </if>
    </target>

    <!-- Target to actually fetch the database dump. -->
    <target name="wget-prod-db">
        <!--Generate .htaccess credential property if needed, empty if not. -->
        <if>
            <or>
                <equals arg1="${project.database.url.htaccess.username}" arg2="" />
                <equals arg1="${project.database.url.htaccess.password}" arg2="" />
            </or>
            <then>
                <!-- If username or password is not provided, empty the credential string. -->
                <property name="project.database.url.credentials"  value="" override="true" />
            </then>
            <else>
                <!-- If username or password is provided, build the credential string. -->
                <property name="project.database.url.credentials"  value="${project.database.url.htaccess.username}:${project.database.url.htaccess.password}@" override="true"  />
            </else>
        </if>
        <!-- Attempt to download the database dump. -->
        <exec command="wget ${project.database.url.scheme}://${project.database.url.credentials}${project.database.url}${project.database.filename}" dir="tmp" checkreturn="false" passthru="false" outputProperty="project.database.download" />
        <if>
            <!-- Upon success inform the user. -->
            <contains string="${project.database.download}" substring="200" />
            <then>
                <echo msg="Database successfully downloaded." />
            </then>
            <!-- When denied access, prompt the user for credentials and retry the download. -->
            <elseif>
                <contains string="${project.database.download}" substring="401" />
                <then>
                    <phingcall target="prompt-for-credentials-and-retry" />
                </then>
            </elseif>
            <!-- Otherwise we fail the build and display the download message. -->
            <else>
                <echo msg="Failed to download the database dump. Result of wget:" level="error" />
                <echo msg="${project.database.download}" level="error" />
                <fail />
            </else>
        </if>
    </target>

    <!-- Simple prompt for user credentials and recurse into wget-prod-db. -->
    <target name="prompt-for-credentials-and-retry" hidden="true">
        <propertyprompt propertyName="project.database.url.htaccess.username" promptText="Please enter your username." />
        <propertyprompt propertyName="project.database.url.htaccess.password" promptText="Please enter your password." />
        <phingcall target="wget-prod-db" />
    </target>

    <!-- Target to check if we have default settings, otherwise propose user to rebuild. -->
    <target name="check-for-default-settings-or-rebuild" hidden="true">
        <if>
            <not>
                <available file="${platform.build.settings.dir}/default.settings.php" type="file" property="platform.build.settings.dir.default.settings" />
            </not>
            <then>
                <!-- If we can not find default settings in the build settings folder, prompt to ask user to rebuild. -->
                <echo msg="No default settings detected at ${platform.build.settings.dir}/default.settings.php." level="warning" />
                <propertyprompt propertyName="platform-rebuild" defaultValue="no" promptText="Do you wish to rebuild? (y/n)" />
                <if>
                    <equals arg1="${platform-rebuild}" arg2="y" />
                    <then>
                        <phingcall target="build-dev" />
                    </then>
                    <else>
                        <!-- If user chooses not to rebuild we have no other choice to fail the build. -->
                        <echo msg="Can not re-generate settings, canceling clone task." level="error" />
                        <fail />
                    </else>
                </if>
            </then>
            <else>
                <!-- If we have found the default settings inform the user we will proceed with generation. -->
                <echo msg="Default settings found at ${platform.build.settings.dir}/default.settings.php." />
                <echo msg="Proceeding with re-generation of the settings.php." />
            </else>
        </if>
    </target>

    <!-- Install a development version of the subsite with a production database. -->
    <target name="build-clone" description="Setup a clone of production." depends="download-prod-db, drush-regenerate-settings, import-prod-db, enable-development-modules" />

</project>
